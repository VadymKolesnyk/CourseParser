<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Course Parser</title>
  </head>
  <body>
    <input type="file" accept=".xml" id="fileinput" />
    <button id="start">Next</button>
    <br /><br /><br />
    <div id="mapper"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <script>
      const prettifyXml = function (sourceXml) {
        var xmlDoc = new DOMParser().parseFromString(
          sourceXml,
          "application/xml"
        );
        var xsltDoc = new DOMParser().parseFromString(
          [
            // describes how we want to modify the XML - indent everything
            '<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">',
            '  <xsl:strip-space elements="*"/>',
            '  <xsl:template match="para[content-style][not(text())]">', // change to just text() to strip space in text nodes
            '    <xsl:value-of select="normalize-space(.)"/>',
            "  </xsl:template>",
            '  <xsl:template match="node()|@*">',
            '    <xsl:copy><xsl:apply-templates select="node()|@*"/></xsl:copy>',
            "  </xsl:template>",
            '  <xsl:output indent="yes"/>',
            "</xsl:stylesheet>",
          ].join("\n"),
          "application/xml"
        );

        var xsltProcessor = new XSLTProcessor();
        xsltProcessor.importStylesheet(xsltDoc);
        var resultDoc = xsltProcessor.transformToDocument(xmlDoc);
        var resultXml = new XMLSerializer().serializeToString(resultDoc);
        return resultXml;
      };

      const createInputBlock = (entity) => {
        const div = document.createElement("div");
        div.innerHTML = `<br/> <h4>${entity.name}</h4> <br/>`;

        const container = document.createElement("div");

        div.appendChild(container);

        const delGroup = (group) => {
          entity.groups = entity.groups.filter((x) => x !== group);
        };

        const createInputs = () =>
          entity.groups.map((x) => {
            const inputTemp = document.createElement("input");
            inputTemp.value = x;
            inputTemp.onchange = () => {
              const index = entity.groups.indexOf(x);
              if (index !== -1) {
                entity.groups[index] = inputTemp.value;
              }
            };
            const delButton = document.createElement("button");
            delButton.innerText = "Delete";
            delButton.onclick = () => {
              delGroup(x);
              render();
            };

            const res = document.createElement("div");
            res.appendChild(inputTemp);
            res.appendChild(delButton);
            return res;
          });

        const render = () => {
          const inputs = createInputs();
          container.innerText = "";
          for (const inputTemp of inputs) {
            container.appendChild(inputTemp);
            container.appendChild(document.createElement("br"));
          }
          const addButton = document.createElement("button");
          addButton.innerText = "Add new";
          addButton.onclick = () => {
            entity.groups = [...entity.groups, ""];
            render();
          };
          container.appendChild(addButton);
        };

        render();
        return div;
      };

      const start = document.getElementById("start");
      const input = document.getElementById("fileinput");
      const mapper = document.getElementById("mapper");

      start.onclick = () => {
        const file = input.files[0];
        var reader = new FileReader();
        reader.readAsText(file, "UTF-8");

        reader.onload = (e) => {
          const text = e.target.result;
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(text, "text/xml");

          const oldNodes = Array.from(xmlDoc.getElementsByTagName("Course"));

          const entities = oldNodes
            .map((x) => ({
              course: x,
              name: x.getElementsByTagName("CourseName")[0].textContent,
            }))
            .map((x) => ({
              ...x,
              groups: x.name.split(";").map((y) => y.trim()),
            }));

          const blocks = entities.map(createInputBlock);
          mapper.append(...blocks);

          const finish = document.createElement("button");
          finish.innerText = "Finish";

          mapper.prepend(finish);

          finish.onclick = () => {
            const newNodes = entities.flatMap((x) =>
              x.groups.map((y) => {
                const element = x.course.cloneNode(true);
                element.getElementsByTagName("CourseName")[0].textContent = y;
                return element;
              })
            );

            for (const node of Array.from(
              xmlDoc.getElementsByTagName("Course")
            )) {
              xmlDoc.documentElement.removeChild(node);
            }

            for (const node of newNodes) {
              xmlDoc.documentElement.appendChild(node);
            }

            var blob = new Blob(
              [prettifyXml(new XMLSerializer().serializeToString(xmlDoc))],
              {
                type: "text/xml",
              }
            );

            saveAs(blob, `${file.name.replace(/\.[^/.]+$/, "")}_updated.xml`);
          };
        };
      };
    </script>
  </body>
</html>
